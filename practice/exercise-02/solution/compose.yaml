# Exercise 01 - SOLUTION
# Initialize Docker Compose with Traefik Reverse Proxy and Dashboard

services:
  traefik:
    # Traefik image version 3.6
    image: traefik:v3.6

    # Exposed ports
    ports:
      - "8080:3080" # HTTP (web entrypoint)
      - "8443:3443" # HTTPS (websecure entrypoint)
      # - "9000:8080" # Traefik Dashboard ()

    # (Bonus) Labels for Traefik service itself
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.dev.dojo.localhost`)"
      - "traefik.http.routers.traefik.entrypoints=web"
      - "traefik.http.routers.traefik.service=api@internal"

    # Mounted volumes
    volumes:
      # Podman socket to monitor containers directly from linux
      # - /run/user/1000/podman/podman.sock:/var/run/docker.sock:ro
      # Docker/Podman socket to monitor containers (comment if using podman from linux directly)
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Traefik configuration
      - ./traefik.yaml:/etc/traefik/traefik.yaml:ro

  # Whoami service
  whoami:
    # Image as specified in requirements
    image: traefik/whoami:v1.11

    # Traefik labels for service discovery
    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"

      # Router configuration
      - "traefik.http.routers.whoami.rule=Host(`whoami.dev.dojo.localhost`)"
      - "traefik.http.routers.whoami.entrypoints=web"
      - "traefik.http.routers.whoami.service=whoami"

      # Service configuration (whoami runs on port 80 by default)
      - "traefik.http.services.whoami.loadbalancer.server.port=80"

  # OpenDraw service
  draw:
    # Image as specified in requirements (using latest instead of the long path)
    image: ghcr.io/thomaschampagne/open-draw:latest

    # Traefik labels for service discovery
    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"

      # Router configuration
      - "traefik.http.routers.draw.rule=Host(`draw.dev.dojo.localhost`)"
      - "traefik.http.routers.draw.entrypoints=web"
      - "traefik.http.routers.draw.service=draw"

      # Service configuration (draw runs on port 80)
      - "traefik.http.services.draw.loadbalancer.server.port=3000"
